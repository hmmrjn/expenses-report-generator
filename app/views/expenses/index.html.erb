<div class="container">

<p id="notice"><%= notice %></p>
<h1>All Expenses</h1>
<p>
  <%= link_to 'Download All Expenses', '#', class: 'btn btn-secondary', 'data-toggle' => 'collapse', 'data-target' => '#collapseDownload', 'aria-expanded' => 'false', 'aria-controls' => 'collapseDonwload'  %>
</p>
<div class="collapse" id="collapseDownload">
  <div class="card">
    <div class="card-body">
      <h5>Download Expenses</h5>
      <%= link_to 'Excel', "/expenses/download_excel_plain", class: 'btn btn-primary' %>
      <%= link_to 'CSV', "/expenses/download_csv", class: 'btn btn-primary' %>
    </div>
  </div>
</div>
<table class="expenses-table">
  <thead>
    <tr>
      <th>Date</th>
      <th>Category</th>
      <th>Sub category</th>
      <th>Amount</th>
      <th colspan="2"></th>
    </tr>
  </thead>

  <tbody>
    <% @expenses.each do |expense| %>
      <tr>
        <td><%= expense.date %></td>
        <td><%= expense.sub_category.category.name.upcase %></td>
        <td><%= expense.sub_category.name.capitalize %></td>
        <td align="right"><%= expense.amount.to_s(:delimited) %></td>
        <td><%= link_to edit_expense_path(expense), title: 'Edit' do %><i class="fas fa-edit"></i><% end %></td>
        <td><%= link_to expense, title: 'Delete', method: :delete, data: { confirm: 'Are you sure?' } do %><i class="fas fa-trash"></i><% end %></td>
      </tr>
    <% end %>
  </tbody>
</table>

<br>
<br>

<h2>Sum of amount for each Sub Category</h2>
<%= link_to 'Download Sums (Excel)', "/expenses/download_sums_excel", class: 'btn btn-primary' %>
<table class="expenses-table">
  <thead>
    <tr>
      <th>Date</th>
      <th>Category</th>
      <th>Sub category</th>
      <th>Amount</th>
    </tr>
  </thead>
  <tbody>
    <% @sub_catgories.each do |sub_category| %>
      <tr>
        <td><%= sub_category.date_span %></td>
        <td><%= sub_category.category.name.upcase %></td>
        <td><%= sub_category.name.titleize %></td>
        <td><%= sub_category.expenses.sum(:amount).to_s(:delimited) %></td>
      </tr>
    <% end %>
  </tbody>
</table>
</div>

<script>
$(function(){
  document.onkeydown = checkKey;
  function checkKey(e) {
      e = e || window.event;
      let temp = parseInt( $('#day_field').val() );
      if (e.keyCode == '38') { //UP KEY
        $('#day_field').val(temp + 1);
      } else if (e.keyCode == '40') { //DOWN KEY
        $('#day_field').val(temp - 1);
      }
      if ($('#day_field').val() <= 0) {
        $('#day_field').val(31);
      } else if ($('#day_field').val() >= 32) {
        $('#day_field').val(1);
      }
  }
})
</script>
